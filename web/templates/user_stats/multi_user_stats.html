{% extends "base.html" %}
{% load static %}
{% load humanize %}

{% block title %}Multi-User Channel Analysis - {{ guild.name }} - User Statistics - WeakAuras{% endblock %}

{% block extra_head %}
<!-- Select2 CSS for searchable dropdowns -->
<link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
<link href="https://cdn.jsdelivr.net/npm/select2-bootstrap-5-theme@1.3.0/dist/select2-bootstrap-5-theme.min.css" rel="stylesheet" />
{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <!-- Header -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center" style="background: linear-gradient(135deg, #9f4af3, #7c3aed); color: white;">
                    <div>
                        <h2 class="mb-0">
                            <i class="fas fa-users me-2"></i>
                            Multi-User Channel Analysis
                        </h2>
                        <p class="mb-0 opacity-75">{{ guild.name }} - Compare multiple users' channel activity</p>
                    </div>
                    <a href="{% url 'user_stats:guild_stats' guild.guild_id %}" class="btn btn-light btn-sm">
                        <i class="fas fa-arrow-left me-1"></i>
                        Back to Server Stats
                    </a>
                </div>
            </div>
        </div>
    </div>

    <!-- Filters and Controls -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="fas fa-filter me-2"></i>
                        Filters & Sorting
                    </h5>
                </div>
                <div class="card-body">
                    <form id="multiUserFilterForm" method="get">
                        <div class="row g-3">
                            <!-- User Selection -->
                            <div class="col-md-4">
                                <label class="form-label">Select Users</label>
                                <select name="user" class="form-select" multiple>
                                    {% for user in available_users %}
                                    <option value="{{ user.user_id }}" {% if user.user_id in selected_user_ids %}selected{% endif %}>
                                        {% if user.display_name == 'Deleted User' or user.username == 'Deleted User' %}
                                            Deleted User #{{ user.user_id|slice:"-4:" }}
                                        {% else %}
                                            {{ user.display_name|default:user.username }}
                                        {% endif %}
                                    </option>
                                    {% endfor %}
                                </select>
                                <small class="text-muted">Leave empty to show top 10 most active users</small>
                            </div>

                            <!-- Sort Period -->
                            <div class="col-md-2">
                                <label class="form-label">Sort by Period</label>
                                <select name="sort_period" class="form-select">
                                    <option value="7d" {% if sort_period == '7d' %}selected{% endif %}>Last 7 Days</option>
                                    <option value="30d" {% if sort_period == '30d' %}selected{% endif %}>Last 30 Days</option>
                                    <option value="90d" {% if sort_period == '90d' %}selected{% endif %}>Last 90 Days</option>
                                    <option value="all" {% if sort_period == 'all' %}selected{% endif %}>All Time</option>
                                </select>
                            </div>

                            <!-- Activity Filter -->
                            <div class="col-md-2">
                                <label class="form-label">Activity Filter</label>
                                <select name="activity_filter" class="form-select">
                                    <option value="all" {% if activity_filter == 'all' %}selected{% endif %}>All Users</option>
                                    <option value="recent" {% if activity_filter == 'recent' %}selected{% endif %}>Recently Active</option>
                                    <option value="active_7d" {% if activity_filter == 'active_7d' %}selected{% endif %}>Active (7 days)</option>
                                    <option value="active_30d" {% if activity_filter == 'active_30d' %}selected{% endif %}>Active (30 days)</option>
                                </select>
                            </div>

                            <!-- Show Channels -->
                            <div class="col-md-2">
                                <label class="form-label">Show Channels</label>
                                <select name="show_channels" class="form-select">
                                    <option value="top5" {% if show_channels == 'top5' %}selected{% endif %}>Top 5</option>
                                    <option value="top10" {% if show_channels == 'top10' %}selected{% endif %}>Top 10</option>
                                    <option value="all" {% if show_channels == 'all' %}selected{% endif %}>All Channels</option>
                                </select>
                            </div>

                            <!-- Apply Button -->
                            <div class="col-md-2 d-flex align-items-end">
                                <button type="submit" class="btn btn-primary w-100">
                                    <i class="fas fa-search me-1"></i>
                                    Apply Filters
                                </button>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Summary Stats -->
    {% if users_data %}
    <div class="row mb-4">
        <div class="col-12">
            <div class="alert alert-info d-flex align-items-center">
                <i class="fas fa-info-circle me-2"></i>
                <span>
                    Showing <strong>{{ total_users }}</strong> user{{ total_users|pluralize }} sorted by activity in <strong>{% if sort_period == '7d' %}last 7 days{% elif sort_period == '30d' %}last 30 days{% elif sort_period == '90d' %}last 90 days{% else %}all time{% endif %}</strong>
                </span>
                <div class="ms-auto">
                    <button class="btn btn-sm btn-outline-primary me-2" id="expandAllBtn">
                        <i class="fas fa-expand-alt me-1"></i>
                        Expand All
                    </button>
                    <button class="btn btn-sm btn-outline-secondary" id="collapseAllBtn">
                        <i class="fas fa-compress-alt me-1"></i>
                        Collapse All
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- User Cards -->
    <div class="row">
        {% for user_id, data in users_data.items %}
        <div class="col-lg-6 col-xl-4 mb-4">
            <div class="card user-card h-100" data-user-id="{{ user_id }}">
                <!-- User Card Header -->
                <div class="card-header user-card-header" style="cursor: pointer;" data-bs-toggle="collapse" data-bs-target="#userCard{{ user_id }}" aria-expanded="false">
                    <div class="d-flex align-items-center">
                        {% if data.user.avatar_url %}
                        <img src="{{ data.user.avatar_url }}" alt="{{ data.user.username }}" class="rounded-circle me-3" style="width: 40px; height: 40px;">
                        {% else %}
                        <div class="rounded-circle bg-primary d-flex align-items-center justify-content-center me-3" style="width: 40px; height: 40px;">
                            <i class="fas fa-user text-white"></i>
                        </div>
                        {% endif %}

                        <div class="flex-grow-1">
                            <div class="d-flex align-items-center">
                                <h6 class="mb-0 me-2">
                                    {% if data.user.display_name == 'Deleted User' or data.user.username == 'Deleted User' %}
                                        Deleted User #{{ data.user.user_id|slice:"-4:" }}
                                    {% else %}
                                        {{ data.user.display_name|default:data.user.username }}
                                    {% endif %}
                                </h6>
                                {% if data.activity_level == 'active_7d' %}
                                <span class="badge bg-success">ðŸŸ¢ Active 7d</span>
                                {% elif data.activity_level == 'active_30d' %}
                                <span class="badge bg-warning">ðŸŸ¡ Active 30d</span>
                                {% elif data.activity_level == 'active_90d' %}
                                <span class="badge bg-info">ðŸ”µ Active 90d</span>
                                {% else %}
                                <span class="badge bg-secondary">âš« Inactive</span>
                                {% endif %}
                            </div>

                            <div class="row text-center mt-2">
                                <div class="col-3">
                                    <small class="text-muted d-block">7d</small>
                                    <strong class="text-success">{{ data.total_stats.messages_7d|intcomma }}</strong>
                                </div>
                                <div class="col-3">
                                    <small class="text-muted d-block">30d</small>
                                    <strong class="text-info">{{ data.total_stats.messages_30d|intcomma }}</strong>
                                </div>
                                <div class="col-3">
                                    <small class="text-muted d-block">90d</small>
                                    <strong class="text-warning">{{ data.total_stats.messages_90d|intcomma }}</strong>
                                </div>
                                <div class="col-3">
                                    <small class="text-muted d-block">Channels</small>
                                    <strong class="text-primary">{{ data.total_stats.channel_count }}</strong>
                                </div>
                            </div>
                        </div>

                        <div class="ms-2">
                            <i class="fas fa-chevron-down collapse-indicator"></i>
                        </div>
                    </div>
                </div>

                <!-- Collapsible Channel Details -->
                <div class="collapse" id="userCard{{ user_id }}">
                    <div class="card-body">
                        {% if data.channels %}
                        <!-- Quick Channel Preview -->
                        <div class="mb-3">
                            <small class="text-muted">Most Active Channels:</small>
                            <div class="mt-1">
                                {% for channel in data.channels|slice:":3" %}
                                <span class="badge bg-light text-dark me-1">
                                    #{{ channel.channel.name }}
                                    ({% if sort_period == '7d' %}{{ channel.messages_7d }}{% elif sort_period == '30d' %}{{ channel.messages_30d }}{% elif sort_period == '90d' %}{{ channel.messages_90d }}{% else %}{{ channel.total_messages }}{% endif %})
                                </span>
                                {% endfor %}
                                {% if data.channels|length > 3 %}
                                <span class="text-muted">+{{ data.channels|length|add:"-3" }} more</span>
                                {% endif %}
                            </div>
                        </div>

                        <!-- Detailed Channel Table -->
                        <div class="table-responsive">
                            <table class="table table-sm table-hover">
                                <thead>
                                    <tr>
                                        <th>Channel</th>
                                        <th class="text-center">7d</th>
                                        <th class="text-center">30d</th>
                                        <th class="text-center">90d</th>
                                        <th class="text-center">Total</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for channel in data.channels %}
                                    <tr>
                                        <td>
                                            <div class="d-flex align-items-center">
                                                <i class="fas fa-hashtag text-muted me-1" style="font-size: 0.8em;"></i>
                                                <span class="text-truncate">{{ channel.channel.name }}</span>
                                            </div>
                                        </td>
                                        <td class="text-center">
                                            {% if channel.messages_7d > 0 %}
                                            <span class="text-success fw-bold">{{ channel.messages_7d|intcomma }}</span>
                                            {% else %}
                                            <span class="text-muted">-</span>
                                            {% endif %}
                                        </td>
                                        <td class="text-center">
                                            {% if channel.messages_30d > 0 %}
                                            <span class="text-info">{{ channel.messages_30d|intcomma }}</span>
                                            {% else %}
                                            <span class="text-muted">-</span>
                                            {% endif %}
                                        </td>
                                        <td class="text-center">
                                            {% if channel.messages_90d > 0 %}
                                            <span class="text-warning">{{ channel.messages_90d|intcomma }}</span>
                                            {% else %}
                                            <span class="text-muted">-</span>
                                            {% endif %}
                                        </td>
                                        <td class="text-center">
                                            <span class="text-primary fw-bold">{{ channel.total_messages|intcomma }}</span>
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                        {% else %}
                        <div class="text-center text-muted py-3">
                            <i class="fas fa-comment-slash fa-2x mb-2"></i>
                            <p class="mb-0">No channel activity found</p>
                        </div>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
        {% endfor %}
    </div>
    {% else %}
    <!-- Empty State -->
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-body text-center py-5">
                    <i class="fas fa-users fa-3x text-muted mb-3"></i>
                    <h4 class="text-muted">No Users Selected</h4>
                    <p class="text-muted mb-4">Select users above to view their channel activity breakdown, or leave it empty to see the top 10 most active users.</p>
                    <button class="btn btn-primary" onclick="document.getElementById('multiUserFilterForm').submit();">
                        <i class="fas fa-search me-1"></i>
                        Show Top 10 Active Users
                    </button>
                </div>
            </div>
        </div>
    </div>
    {% endif %}
</div>

<style>
/* Activity level badges */
.badge {
    font-size: 0.7em;
}

/* User card hover effects */
.user-card {
    transition: transform 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
}

.user-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
}

/* Collapse indicator rotation */
.collapse-indicator {
    transition: transform 0.3s ease-in-out;
}

.user-card-header[aria-expanded="true"] .collapse-indicator {
    transform: rotate(180deg);
}

/* Select2 Bootstrap 5 Theme Customizations */
.select2-container--bootstrap-5 .select2-selection--single {
    height: calc(1.5em + 0.75rem + 2px) !important;
    padding: 0.375rem 0.75rem !important;
}

.select2-container--bootstrap-5 .select2-dropdown {
    border-color: #ced4da !important;
    max-height: 300px !important;
    overflow-y: auto !important;
}

.select2-container--bootstrap-5 .select2-results__option--highlighted {
    background-color: #9f4af3 !important;
}

.select2-container--bootstrap-5 .select2-results__option--selected {
    background-color: #e7d9f7 !important;
    color: #6f2c91 !important;
}

/* Performance optimizations for large lists */
.select2-results__options {
    max-height: 250px !important;
    overflow-y: auto !important;
    transform: translateZ(0);
    -webkit-overflow-scrolling: touch;
}

.select2-container--bootstrap-5 .select2-results__option {
    padding: 0.375rem 0.75rem !important;
    white-space: nowrap !important;
    overflow: hidden !important;
    text-overflow: ellipsis !important;
}

/* Responsive adjustments */
@media (max-width: 768px) {
    .user-card .row.text-center .col-3 {
        font-size: 0.9em;
    }

    .table-responsive table {
        font-size: 0.9em;
    }
}

/* Loading states */
.filter-loading {
    position: fixed;
    top: 20px;
    right: 20px;
    z-index: 9999;
}
</style>

<!-- jQuery and Select2 JavaScript -->
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Initialize Select2 for user selection
    const userSelect = $('select[name="user"]');

    if (userSelect.length) {
        userSelect.select2({
            theme: 'bootstrap-5',
            placeholder: 'Search for users...',
            allowClear: true,
            width: '100%',
            multiple: true,
            minimumInputLength: 1,
            closeOnSelect: false,
            delay: 150,
            templateSelection: function(user) {
                return $('<span>').text(user.text);
            }
        });

        // Clear search input when user is selected
        userSelect.on('select2:select', function(e) {
            const select2Instance = $(this).data('select2');
            setTimeout(() => {
                const $dropdownSearch = select2Instance.$dropdown.find('.select2-search__field');
                const $selectionSearch = select2Instance.$selection.find('.select2-search__field');

                $dropdownSearch.val('');
                $selectionSearch.val('');
                $selectionSearch.focus();
            }, 25);
        });
    }

    // Expand/Collapse All functionality
    const expandAllBtn = document.getElementById('expandAllBtn');
    const collapseAllBtn = document.getElementById('collapseAllBtn');

    if (expandAllBtn) {
        expandAllBtn.addEventListener('click', function() {
            const collapses = document.querySelectorAll('.user-card .collapse');
            collapses.forEach(collapse => {
                const bsCollapse = new bootstrap.Collapse(collapse, {toggle: false});
                bsCollapse.show();
            });
        });
    }

    if (collapseAllBtn) {
        collapseAllBtn.addEventListener('click', function() {
            const collapses = document.querySelectorAll('.user-card .collapse');
            collapses.forEach(collapse => {
                const bsCollapse = new bootstrap.Collapse(collapse, {toggle: false});
                bsCollapse.hide();
            });
        });
    }

    // Form submission with loading indicator
    const form = document.getElementById('multiUserFilterForm');
    if (form) {
        form.addEventListener('submit', function() {
            // Show loading indicator
            const existingLoading = document.querySelector('.filter-loading');
            if (!existingLoading) {
                const loadingDiv = document.createElement('div');
                loadingDiv.className = 'filter-loading alert alert-info d-flex align-items-center';
                loadingDiv.innerHTML = `
                    <div class="spinner-border spinner-border-sm me-2" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                    Applying filters...
                `;
                document.body.appendChild(loadingDiv);
            }
        });
    }
});
</script>
{% endblock %}
