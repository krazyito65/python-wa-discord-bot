{% extends "base.html" %}
{% load humanize %}

{% block title %}Role Settings - {{ guild_name }}{% endblock %}

{% block content %}
<div class="container my-4">
    <!-- Header -->
    <div class="row">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <div>
                    <h1 class="h3 mb-1">ðŸ‘¥ Role Settings</h1>
                    <p class="text-muted mb-0">{{ guild_name }}</p>
                </div>
                <div>
                    <a href="{% url 'admin_panel:dashboard' guild_id %}" class="btn btn-outline-secondary">
                        <i class="fas fa-arrow-left"></i> Back to Admin Panel
                    </a>
                </div>
            </div>
        </div>
    </div>

    <!-- Role Settings Form -->
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-users"></i> Configure Role Names
                    </h5>
                </div>
                <div class="card-body">
                    <form method="post">
                        {% csrf_token %}

                        <!-- Standard Role Categories -->
                        <div class="row g-4">
                            <!-- Admin Roles -->
                            <div class="col-md-4">
                                <div class="card border-danger">
                                    <div class="card-header bg-danger text-white">
                                        <h6 class="mb-0">
                                            <i class="fas fa-crown"></i> Administrator Roles
                                        </h6>
                                    </div>
                                    <div class="card-body">
                                        <label for="admin_roles" class="form-label">Select Admin Roles</label>
                                        <select class="form-select role-select" id="admin_roles" name="admin_roles" multiple size="5" data-role-type="Admin">
                                            {% for role in discord_roles %}
                                                {% if role.name != "@everyone" %}
                                                    <option value="{{ role.id }}"
                                                            {% if role.name in server_config.admin_roles %}selected{% endif %}>
                                                        {{ role.name }}
                                                    </option>
                                                {% endif %}
                                            {% endfor %}
                                        </select>
                                        <small class="form-text text-muted">
                                            Hold Ctrl/Cmd to select multiple roles. <span class="role-count" data-target="admin_roles"></span>
                                        </small>
                                    </div>
                                </div>
                            </div>

                            <!-- Moderator Roles -->
                            <div class="col-md-4">
                                <div class="card border-warning">
                                    <div class="card-header bg-warning text-white">
                                        <h6 class="mb-0">
                                            <i class="fas fa-shield"></i> Moderator Roles
                                        </h6>
                                    </div>
                                    <div class="card-body">
                                        <label for="moderator_roles" class="form-label">Select Moderator Roles</label>
                                        <select class="form-select role-select" id="moderator_roles" name="moderator_roles" multiple size="5" data-role-type="Moderator">
                                            {% for role in discord_roles %}
                                                {% if role.name != "@everyone" %}
                                                    <option value="{{ role.id }}"
                                                            {% if role.name in server_config.moderator_roles %}selected{% endif %}>
                                                        {{ role.name }}
                                                    </option>
                                                {% endif %}
                                            {% endfor %}
                                        </select>
                                        <small class="form-text text-muted">
                                            Hold Ctrl/Cmd to select multiple roles. <span class="role-count" data-target="moderator_roles"></span>
                                        </small>
                                    </div>
                                </div>
                            </div>

                            <!-- Trusted User Roles -->
                            <div class="col-md-4">
                                <div class="card border-info">
                                    <div class="card-header bg-info text-white">
                                        <h6 class="mb-0">
                                            <i class="fas fa-star"></i> Trusted User Roles
                                        </h6>
                                    </div>
                                    <div class="card-body">
                                        <label for="trusted_user_roles" class="form-label">Select Trusted User Roles</label>
                                        <select class="form-select role-select" id="trusted_user_roles" name="trusted_user_roles" multiple size="5" data-role-type="Trusted User">
                                            {% for role in discord_roles %}
                                                {% if role.name != "@everyone" %}
                                                    <option value="{{ role.id }}"
                                                            {% if role.name in server_config.trusted_user_roles %}selected{% endif %}>
                                                        {{ role.name }}
                                                    </option>
                                                {% endif %}
                                            {% endfor %}
                                        </select>
                                        <small class="form-text text-muted">
                                            Hold Ctrl/Cmd to select multiple roles. <span class="role-count" data-target="trusted_user_roles"></span>
                                        </small>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Custom Permission Roles -->
                        <div class="row g-4 mt-3">
                            <div class="col-12">
                                <h6 class="text-muted">
                                    <i class="fas fa-cogs"></i> Custom Permission Roles
                                    <small class="text-muted">(Used when permission level is set to "Custom Roles Only")</small>
                                </h6>
                            </div>

                            <!-- Custom Admin Panel Roles -->
                            <div class="col-md-6">
                                <div class="card border-primary">
                                    <div class="card-header bg-primary text-white">
                                        <h6 class="mb-0">
                                            <i class="fas fa-shield-alt"></i> Admin Panel Access
                                        </h6>
                                    </div>
                                    <div class="card-body">
                                        <label for="custom_admin_panel_roles" class="form-label">Select Custom Admin Panel Roles</label>
                                        <select class="form-select role-select" id="custom_admin_panel_roles" name="custom_admin_panel_roles" multiple size="4" data-role-type="Custom Admin Panel">
                                            {% for role in discord_roles %}
                                                {% if role.name != "@everyone" %}
                                                    <option value="{{ role.id }}"
                                                            {% if role.name in server_config.custom_admin_panel_roles %}selected{% endif %}>
                                                        {{ role.name }}
                                                    </option>
                                                {% endif %}
                                            {% endfor %}
                                        </select>
                                        <small class="form-text text-muted">
                                            Hold Ctrl/Cmd to select multiple roles. <span class="role-count" data-target="custom_admin_panel_roles"></span>
                                        </small>
                                    </div>
                                </div>
                            </div>

                            <!-- Custom Create Roles -->
                            <div class="col-md-6">
                                <div class="card border-success">
                                    <div class="card-header bg-success text-white">
                                        <h6 class="mb-0">
                                            <i class="fas fa-plus-circle"></i> Create Macros
                                        </h6>
                                    </div>
                                    <div class="card-body">
                                        <label for="custom_create_roles" class="form-label">Select Custom Create Roles</label>
                                        <select class="form-select role-select" id="custom_create_roles" name="custom_create_roles" multiple size="4" data-role-type="Custom Create">
                                            {% for role in discord_roles %}
                                                {% if role.name != "@everyone" %}
                                                    <option value="{{ role.id }}"
                                                            {% if role.name in server_config.custom_create_roles %}selected{% endif %}>
                                                        {{ role.name }}
                                                    </option>
                                                {% endif %}
                                            {% endfor %}
                                        </select>
                                        <small class="form-text text-muted">
                                            Hold Ctrl/Cmd to select multiple roles. <span class="role-count" data-target="custom_create_roles"></span>
                                        </small>
                                    </div>
                                </div>
                            </div>

                            <!-- Custom Edit Roles -->
                            <div class="col-md-6">
                                <div class="card border-warning">
                                    <div class="card-header bg-warning text-white">
                                        <h6 class="mb-0">
                                            <i class="fas fa-edit"></i> Edit Macros
                                        </h6>
                                    </div>
                                    <div class="card-body">
                                        <label for="custom_edit_roles" class="form-label">Select Custom Edit Roles</label>
                                        <select class="form-select role-select" id="custom_edit_roles" name="custom_edit_roles" multiple size="4" data-role-type="Custom Edit">
                                            {% for role in discord_roles %}
                                                {% if role.name != "@everyone" %}
                                                    <option value="{{ role.id }}"
                                                            {% if role.name in server_config.custom_edit_roles %}selected{% endif %}>
                                                        {{ role.name }}
                                                    </option>
                                                {% endif %}
                                            {% endfor %}
                                        </select>
                                        <small class="form-text text-muted">
                                            Hold Ctrl/Cmd to select multiple roles. <span class="role-count" data-target="custom_edit_roles"></span>
                                        </small>
                                    </div>
                                </div>
                            </div>

                            <!-- Custom Delete Roles -->
                            <div class="col-md-6">
                                <div class="card border-danger">
                                    <div class="card-header bg-danger text-white">
                                        <h6 class="mb-0">
                                            <i class="fas fa-trash-alt"></i> Delete Macros
                                        </h6>
                                    </div>
                                    <div class="card-body">
                                        <label for="custom_delete_roles" class="form-label">Select Custom Delete Roles</label>
                                        <select class="form-select role-select" id="custom_delete_roles" name="custom_delete_roles" multiple size="4" data-role-type="Custom Delete">
                                            {% for role in discord_roles %}
                                                {% if role.name != "@everyone" %}
                                                    <option value="{{ role.id }}"
                                                            {% if role.name in server_config.custom_delete_roles %}selected{% endif %}>
                                                        {{ role.name }}
                                                    </option>
                                                {% endif %}
                                            {% endfor %}
                                        </select>
                                        <small class="form-text text-muted">
                                            Hold Ctrl/Cmd to select multiple roles. <span class="role-count" data-target="custom_delete_roles"></span>
                                        </small>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Save Button -->
                        <div class="row mt-4">
                            <div class="col-12">
                                <hr>
                                <div class="d-flex justify-content-between">
                                    <div>
                                        <small class="text-muted">
                                            <i class="fas fa-info-circle"></i>
                                            Role names are case-insensitive. Changes will be logged for auditing.
                                        </small>
                                    </div>
                                    <div>
                                        <button type="submit" class="btn btn-primary">
                                            <i class="fas fa-save"></i> Save Role Settings
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Help Section -->
    <div class="row mt-4">
        <div class="col-12">
            <div class="card border-info">
                <div class="card-header bg-info text-white">
                    <h6 class="mb-0">
                        <i class="fas fa-lightbulb"></i> Tips & Guidelines
                    </h6>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <h6>Role Selection Guidelines</h6>
                            <ul class="small">
                                <li>Hold <strong>Ctrl/Cmd</strong> to select multiple roles</li>
                                <li>Role IDs are used internally for security</li>
                                <li>Roles are sorted by Discord hierarchy (highest first)</li>
                                <li>@everyone role is excluded from selection</li>
                                <li>No selection means no roles have that privilege</li>
                            </ul>
                        </div>
                        <div class="col-md-6">
                            <h6>Permission Hierarchy</h6>
                            <ul class="small">
                                <li><strong>Admin roles</strong> have the highest privileges</li>
                                <li><strong>Moderator roles</strong> include admin privileges when selected</li>
                                <li><strong>Trusted user roles</strong> include mod and admin privileges when selected</li>
                                <li><strong>Custom roles</strong> work independently of hierarchy</li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Update role selection counters
    function updateRoleCount(selectElement) {
        const targetId = selectElement.id;
        const countSpan = document.querySelector(`.role-count[data-target="${targetId}"]`);
        if (countSpan) {
            const selectedCount = selectElement.selectedOptions.length;
            const roleType = selectElement.dataset.roleType || 'roles';

            if (selectedCount === 0) {
                countSpan.textContent = `(No ${roleType.toLowerCase()} selected)`;
                countSpan.className = 'role-count text-muted';
            } else if (selectedCount === 1) {
                countSpan.textContent = `(1 ${roleType.toLowerCase().slice(0, -1)} selected)`;
                countSpan.className = 'role-count text-info';
            } else {
                countSpan.textContent = `(${selectedCount} ${roleType.toLowerCase()} selected)`;
                countSpan.className = 'role-count text-success';
            }
        }
    }

    // Initialize counters and add event listeners
    document.querySelectorAll('.role-select').forEach(function(select) {
        // Update initial count
        updateRoleCount(select);

        // Update count on change
        select.addEventListener('change', function() {
            updateRoleCount(this);
        });

        // Add visual feedback for better UX
        select.addEventListener('focus', function() {
            this.style.borderColor = 'var(--wa-purple)';
        });

        select.addEventListener('blur', function() {
            this.style.borderColor = 'var(--input-border)';
        });
    });

    // Add keyboard shortcut hint
    const roleSelects = document.querySelectorAll('.role-select');
    if (roleSelects.length > 0) {
        // Add a subtle animation to highlight the role selection
        roleSelects.forEach(function(select) {
            select.addEventListener('mouseenter', function() {
                this.style.transition = 'box-shadow 0.2s ease';
                this.style.boxShadow = '0 0 0 0.1rem rgba(159, 74, 243, 0.15)';
            });

            select.addEventListener('mouseleave', function() {
                this.style.boxShadow = 'none';
            });
        });
    }
});
</script>

{% endblock %}
