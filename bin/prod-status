#!/bin/bash
# Check production service status
# Usage: bin/prod-status

set -euo pipefail

echo "ğŸ“Š Production Service Status"
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo ""

# Service status
echo "ğŸ” Service Status:"
echo "  â€¢ Discord Bot: $(sudo systemctl is-active weakauras-bot)"
echo "  â€¢ Django Web: $(sudo systemctl is-active weakauras-django)"
echo "  â€¢ Nginx Proxy: $(sudo systemctl is-active nginx)"
echo ""

# Website test
echo "ğŸŒ Website Check:"
if curl -s -I https://bot.weakauras.wtf | head -1 | grep -q "HTTP/2 [23][0-9][0-9]"; then
    echo "  â€¢ https://bot.weakauras.wtf: âœ… ONLINE"
else
    echo "  â€¢ https://bot.weakauras.wtf: âŒ OFFLINE"
fi
echo ""

# Disk space
echo "ğŸ’¾ Disk Usage:"
df -h / | awk 'NR==2 {print "  â€¢ Root: " $3 "/" $2 " (" $5 " used)"}'
echo ""

# Memory usage
echo "ğŸ§  Memory Usage:"
free -h | awk 'NR==2 {print "  â€¢ RAM: " $3 "/" $2 " (" int($3/$2*100) "% used)"}'
echo ""

# Recent errors (last 5 minutes)
echo "âš ï¸  Recent Errors (last 5 minutes):"
error_count=$(sudo journalctl -u weakauras-bot -u weakauras-django --since "5 minutes ago" | grep -i "error\|critical\|exception" | wc -l)
if [ "$error_count" -eq 0 ]; then
    echo "  â€¢ No errors found âœ…"
else
    echo "  â€¢ Found $error_count errors âš ï¸"
    echo "  â€¢ Check logs: bin/prod-logs-all"
fi
echo ""

echo "ğŸ“ Available Commands:"
echo "  â€¢ bin/prod-restart-all    - Restart all services"
echo "  â€¢ bin/prod-restart-bot    - Restart Discord bot only"
echo "  â€¢ bin/prod-restart-web    - Restart web interface only"
echo "  â€¢ bin/prod-logs-all       - View all service logs (systemd journal)"
echo "  â€¢ bin/prod-logs-bot       - View Discord bot logs (systemd journal)"
echo "  â€¢ bin/prod-logs-web       - View web interface logs (systemd journal)"
echo "  â€¢ bin/prod-logs-text      - View logs from text files (text editor friendly)"
echo "  â€¢ bin/prod-logs-export    - Export logs to text file for editing"
