#!/bin/bash
# Check log rotation status and disk usage
# Usage: bin/prod-logs-status

set -euo pipefail

echo "ðŸ“Š WeakAuras Production Log Status"
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo ""

# SystemD Journal Status
echo "ðŸ—‚ï¸  SystemD Journal:"
echo "   $(journalctl --disk-usage)"
echo ""

# Nginx Log Files
echo "ðŸ“„ Nginx Log Files:"
if ls /var/log/nginx/weakauras-bot-*.log >/dev/null 2>&1; then
    du -h /var/log/nginx/weakauras-bot-*.log | while read size file; do
        echo "   â€¢ $(basename "$file"): $size"
    done
else
    echo "   â€¢ No WeakAuras nginx logs found"
fi
echo ""

# Log Rotation Configuration
echo "ðŸ”„ Log Rotation Settings:"
echo "   â€¢ SystemD Journal: Max 100MB total, 30 days retention"
echo "   â€¢ Nginx Logs: Max 10MB per file, 7 days retention"
echo "   â€¢ Files rotate weekly or when size limit reached"
echo ""

# Last Rotation Status
echo "â° Last Rotation Status:"
if [ -f /var/lib/logrotate/status ]; then
    grep -E "(weakauras|nginx)" /var/lib/logrotate/status 2>/dev/null | head -5 || echo "   â€¢ No rotation history found"
else
    echo "   â€¢ Logrotate status file not found"
fi
echo ""

echo "ðŸ’¡ Log Management Commands:"
echo "   â€¢ bin/prod-logs-all     - View live logs"
echo "   â€¢ journalctl --vacuum-time=7d  - Clean old journal logs manually"
echo "   â€¢ logrotate -f /etc/logrotate.d/weakauras-bot  - Force log rotation"
